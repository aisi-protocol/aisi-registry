<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AISI Registry - æœåŠ¡æ³¨å†Œä¸­å¿ƒ</title>
    <meta name="description" content="AISIåè®®å®˜æ–¹æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä¸ºæ™ºèƒ½ä½“æä¾›æ ‡å‡†åŒ–çš„åŸå­æœåŠ¡ç›®å½•">
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <!-- Polyfill for older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
</head>
<body>
    <div id="app">
        <!-- Vueåº”ç”¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
    </div>

    <!-- Vue 3 and Element Plus from CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Main Vue Application -->
    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { 
            ElButton, ElForm, ElFormItem, ElInput, ElSelect, ElOption,
            ElMessage, ElMessageBox, ElLoading, ElCard, ElTag,
            ElRow, ElCol, ElPagination, ElTable, ElTableColumn,
            ElTabs, ElTabPane, ElLink, ElEmpty
        } = ElementPlus;

        const app = createApp({
            setup() {
                // å“åº”å¼æ•°æ®
                const currentRoute = ref('home');
                const services = ref([]);
                const loading = ref(false);
                const searchQuery = ref('');
                const currentCategory = ref('all');
                const currentPage = ref(1);
                const pageSize = ref(10);
                const totalServices = ref(0);
                
                // æ³¨å†Œè¡¨å•æ•°æ®
                const registerForm = reactive({
                    provider: '',
                    service_name: '',
                    endpoint: '',
                    description_zh: '',
                    category: 'other'
                });
                
                const registerRules = {
                    provider: [
                        { required: true, message: 'è¯·è¾“å…¥æœåŠ¡å•†åç§°', trigger: 'blur' },
                        { pattern: /^[a-z0-9-]+$/, message: 'åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œæ¨ªçº¿', trigger: 'blur' }
                    ],
                    service_name: [
                        { required: true, message: 'è¯·è¾“å…¥æœåŠ¡åç§°', trigger: 'blur' },
                        { pattern: /^[a-z0-9-]+$/, message: 'åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œæ¨ªçº¿', trigger: 'blur' }
                    ],
                    endpoint: [
                        { required: true, message: 'è¯·è¾“å…¥APIç«¯ç‚¹', trigger: 'blur' },
                        { type: 'url', message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„URL', trigger: 'blur' }
                    ]
                };
                
                // è®¡ç®—å±æ€§
                const paginatedServices = computed(() => {
                    let filtered = services.value;
                    
                    if (searchQuery.value) {
                        const query = searchQuery.value.toLowerCase();
                        filtered = filtered.filter(s => 
                            s.id.toLowerCase().includes(query) ||
                            s.description.toLowerCase().includes(query) ||
                            s.provider.toLowerCase().includes(query)
                        );
                    }
                    
                    if (currentCategory.value !== 'all') {
                        filtered = filtered.filter(s => s.category === currentCategory.value);
                    }
                    
                    totalServices.value = filtered.length;
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filtered.slice(start, end);
                });
                
                const categories = computed(() => {
                    const cats = new Set(services.value.map(s => s.category));
                    return ['all', ...Array.from(cats)].filter(Boolean);
                });
                
                // æ–¹æ³•
                const navigateTo = (route) => {
                    currentRoute.value = route;
                    window.location.hash = `#/${route}`;
                };
                
                const loadServices = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get('/api/directory');
                        if (response.data.success) {
                            services.value = response.data.services;
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½æœåŠ¡ç›®å½•å¤±è´¥: ' + error.message);
                    } finally {
                        loading.value = false;
                    }
                };
                
                const handleRegister = async () => {
                    try {
                        const response = await axios.post('/api/register', registerForm);
                        if (response.data.success) {
                            ElMessage.success('æœåŠ¡æ³¨å†ŒæˆåŠŸï¼');
                            // é‡ç½®è¡¨å•
                            Object.keys(registerForm).forEach(key => registerForm[key] = '');
                            registerForm.category = 'other';
                            // é‡æ–°åŠ è½½æœåŠ¡
                            await loadServices();
                            navigateTo('directory');
                        }
                    } catch (error) {
                        ElMessage.error(error.response?.data?.error || 'æ³¨å†Œå¤±è´¥');
                    }
                };
                
                const resolveService = async (serviceId) => {
                    try {
                        const response = await axios.get(`/api/resolve?serviceId=${encodeURIComponent(serviceId)}`);
                        if (response.data.success) {
                            ElMessageBox.alert(
                                `<h3>${serviceId}</h3>
                                <p><strong>ç«¯ç‚¹:</strong> ${response.data.service.endpoint}</p>
                                <p><strong>æ–¹æ³•:</strong> ${response.data.service.method}</p>
                                <p><strong>æè¿°:</strong> ${response.data.service.description}</p>`,
                                'æœåŠ¡è§£æç»“æœ',
                                {
                                    dangerouslyUseHTMLString: true,
                                    confirmButtonText: 'ç¡®å®š'
                                }
                            );
                        }
                    } catch (error) {
                        ElMessage.error('è§£ææœåŠ¡å¤±è´¥: ' + (error.response?.data?.error || error.message));
                    }
                };
                
                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    loadServices();
                    
                    // å¤„ç†è·¯ç”±
                    const hash = window.location.hash.slice(2) || 'home';
                    currentRoute.value = hash;
                    
                    window.onhashchange = () => {
                        const newHash = window.location.hash.slice(2) || 'home';
                        currentRoute.value = newHash;
                    };
                });
                
                return {
                    currentRoute,
                    services,
                    loading,
                    searchQuery,
                    currentCategory,
                    currentPage,
                    pageSize,
                    totalServices,
                    registerForm,
                    registerRules,
                    paginatedServices,
                    categories,
                    navigateTo,
                    loadServices,
                    handleRegister,
                    resolveService
                };
            },
            
            template: `
                <div class="app-container">
                    <!-- é¡¶éƒ¨å¯¼èˆª -->
                    <header class="app-header">
                        <div class="header-content">
                            <div class="logo" @click="navigateTo('home')">
                                <span class="aisi">AISI</span>
                                <span class="registry">Registry</span>
                            </div>
                            <div class="nav-links">
                                <el-link :underline="false" @click="navigateTo('home')" :type="currentRoute === 'home' ? 'primary' : ''">é¦–é¡µ</el-link>
                                <el-link :underline="false" @click="navigateTo('directory')" :type="currentRoute === 'directory' ? 'primary' : ''">æœåŠ¡ç›®å½•</el-link>
                                <el-link :underline="false" @click="navigateTo('register')" :type="currentRoute === 'register' ? 'primary' : ''">æ³¨å†ŒæœåŠ¡</el-link>
                                <el-link :underline="false" href="https://aisi.run" target="_blank">å…³äº</el-link>
                            </div>
                            <div class="domain">registry.aisi.run</div>
                        </div>
                    </header>
                    
                    <!-- ä¸»è¦å†…å®¹ -->
                    <main class="app-main">
                        <!-- é¦–é¡µ -->
                        <div v-if="currentRoute === 'home'" class="home-page">
                            <div class="hero">
                                <h1>AISI æœåŠ¡æ³¨å†Œä¸­å¿ƒ</h1>
                                <p class="subtitle">ä¸ºæ™ºèƒ½ä½“æä¾›æ ‡å‡†åŒ–çš„åŸå­æœåŠ¡ç›®å½•</p>
                                <div class="actions">
                                    <el-button type="primary" size="large" @click="navigateTo('directory')">
                                        æµè§ˆæœåŠ¡ç›®å½•
                                    </el-button>
                                    <el-button size="large" @click="navigateTo('register')">
                                        æ³¨å†Œä½ çš„æœåŠ¡
                                    </el-button>
                                </div>
                            </div>
                            
                            <div class="features">
                                <el-row :gutter="30">
                                    <el-col :xs="24" :sm="12" :md="8">
                                        <el-card class="feature-card">
                                            <template #header>
                                                <div class="feature-icon">ğŸ”</div>
                                                <h3>æœåŠ¡å‘ç°</h3>
                                            </template>
                                            <p>é€šè¿‡ç»Ÿä¸€çš„ aisi:// åè®®å‘ç°å’Œè°ƒç”¨æœåŠ¡</p>
                                        </el-card>
                                    </el-col>
                                    <el-col :xs="24" :sm="12" :md="8">
                                        <el-card class="feature-card">
                                            <template #header>
                                                <div class="feature-icon">ğŸ“</div>
                                                <h3>ç®€å•æ³¨å†Œ</h3>
                                            </template>
                                            <p>å¡«å†™è¡¨å•å³å¯å°†ä½ çš„APIæœåŠ¡æ¥å…¥AISIç”Ÿæ€</p>
                                        </el-card>
                                    </el-col>
                                    <el-col :xs="24" :sm="12" :md="8">
                                        <el-card class="feature-card">
                                            <template #header>
                                                <div class="feature-icon">ğŸ¤–</div>
                                                <h3>æ™ºèƒ½ä½“å‹å¥½</h3>
                                            </template>
                                            <p>ä¸ºAIæ™ºèƒ½ä½“æä¾›ç»“æ„åŒ–ã€å¯ç†è§£çš„æœåŠ¡æè¿°</p>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                            
                            <div class="quick-stats">
                                <el-card>
                                    <h3>å½“å‰çŠ¶æ€</h3>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-number">{{ services.length }}</div>
                                            <div class="stat-label">å¯ç”¨æœåŠ¡</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number">{{ new Set(services.map(s => s.provider)).size }}</div>
                                            <div class="stat-label">æœåŠ¡å•†</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number">{{ new Set(services.map(s => s.category)).size }}</div>
                                            <div class="stat-label">åˆ†ç±»</div>
                                        </div>
                                    </div>
                                </el-card>
                            </div>
                        </div>
                        
                        <!-- æœåŠ¡ç›®å½•é¡µ -->
                        <div v-else-if="currentRoute === 'directory'" class="directory-page">
                            <div class="page-header">
                                <h1>æœåŠ¡ç›®å½•</h1>
                                <p>æµè§ˆæ‰€æœ‰å¯ç”¨çš„AISIåŸå­æœåŠ¡</p>
                            </div>
                            
                            <div class="directory-controls">
                                <el-input 
                                    v-model="searchQuery" 
                                    placeholder="æœç´¢æœåŠ¡åç§°ã€æè¿°æˆ–æœåŠ¡å•†..." 
                                    clearable
                                    style="max-width: 400px;"
                                >
                                    <template #prefix>
                                        <el-icon><Search /></el-icon>
                                    </template>
                                </el-input>
                                
                                <el-select v-model="currentCategory" placeholder="é€‰æ‹©åˆ†ç±»" clearable>
                                    <el-option 
                                        v-for="cat in categories" 
                                        :key="cat" 
                                        :label="cat === 'all' ? 'å…¨éƒ¨' : cat" 
                                        :value="cat"
                                    />
                                </el-select>
                            </div>
                            
                            <div v-loading="loading" class="services-grid">
                                <div v-if="paginatedServices.length === 0" class="empty-state">
                                    <el-empty description="æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æœåŠ¡" />
                                </div>
                                
                                <el-row :gutter="20">
                                    <el-col v-for="service in paginatedServices" :key="service.id" :xs="24" :sm="12" :md="8" :lg="6">
                                        <el-card class="service-card" shadow="hover">
                                            <template #header>
                                                <div class="service-header">
                                                    <el-tag size="small" :type="service.status === 'active' ? 'success' : 'warning'">
                                                        {{ service.status === 'active' ? 'æ´»è·ƒ' : 'å¾…å®¡' }}
                                                    </el-tag>
                                                    <el-tag size="small" type="info">{{ service.category }}</el-tag>
                                                </div>
                                            </template>
                                            
                                            <h4 class="service-title">{{ service.name_zh || service.name }}</h4>
                                            <p class="service-description">{{ service.description }}</p>
                                            
                                            <div class="service-meta">
                                                <div class="service-provider">
                                                    <strong>æœåŠ¡å•†:</strong> {{ service.provider }}
                                                </div>
                                                <div class="service-id">
                                                    <strong>ID:</strong> <code>{{ service.id }}</code>
                                                </div>
                                            </div>
                                            
                                            <template #footer>
                                                <div class="service-actions">
                                                    <el-button type="primary" size="small" @click="resolveService(service.id)">
                                                        è§£ææœåŠ¡
                                                    </el-button>
                                                    <el-button size="small" @click="ElMessage.info('æœåŠ¡è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­')">
                                                        è¯¦æƒ…
                                                    </el-button>
                                                </div>
                                            </template>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                            
                            <div v-if="paginatedServices.length > 0" class="pagination-container">
                                <el-pagination
                                    v-model:current-page="currentPage"
                                    v-model:page-size="pageSize"
                                    :page-sizes="[10, 20, 50, 100]"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="totalServices"
                                    @size-change="loadServices"
                                    @current-change="loadServices"
                                />
                            </div>
                        </div>
                        
                        <!-- æœåŠ¡æ³¨å†Œé¡µ -->
                        <div v-else-if="currentRoute === 'register'" class="register-page">
                            <div class="page-header">
                                <h1>æ³¨å†ŒAISIåŸå­æœåŠ¡</h1>
                                <p>å°†ä½ çš„APIæœåŠ¡æ¥å…¥AISIç”Ÿæ€ç³»ç»Ÿ</p>
                            </div>
                            
                            <el-card class="register-form-card">
                                <el-form 
                                    ref="registerFormRef"
                                    :model="registerForm" 
                                    :rules="registerRules" 
                                    label-width="120px"
                                    label-position="top"
                                >
                                    <el-form-item label="æœåŠ¡å•†åç§°" prop="provider">
                                        <el-input 
                                            v-model="registerForm.provider" 
                                            placeholder="your-company"
                                            clearable
                                        />
                                        <div class="form-hint">å°å†™å­—æ¯ã€æ•°å­—ã€æ¨ªçº¿ï¼Œå°†ç”¨äº aisi://{provider}/...</div>
                                    </el-form-item>
                                    
                                    <el-form-item label="æœåŠ¡åç§°" prop="service_name">
                                        <el-input 
                                            v-model="registerForm.service_name" 
                                            placeholder="weather-service"
                                            clearable
                                        />
                                        <div class="form-hint">å°å†™å­—æ¯ã€æ•°å­—ã€æ¨ªçº¿ï¼Œå°†ç”Ÿæˆ aisi://provider/{service-name}</div>
                                    </el-form-item>
                                    
                                    <el-form-item label="APIç«¯ç‚¹" prop="endpoint">
                                        <el-input 
                                            v-model="registerForm.endpoint" 
                                            placeholder="https://api.example.com/v1/service"
                                            clearable
                                        />
                                        <div class="form-hint">å®Œæ•´çš„HTTP/HTTPS APIåœ°å€</div>
                                    </el-form-item>
                                    
                                    <el-form-item label="æœåŠ¡æè¿°">
                                        <el-input 
                                            v-model="registerForm.description_zh" 
                                            type="textarea" 
                                            :rows="3"
                                            placeholder="ç®€è¦æè¿°æœåŠ¡çš„åŠŸèƒ½å’Œç”¨é€”"
                                            maxlength="200"
                                            show-word-limit
                                        />
                                    </el-form-item>
                                    
                                    <el-form-item label="æœåŠ¡åˆ†ç±»">
                                        <el-select v-model="registerForm.category" placeholder="é€‰æ‹©åˆ†ç±»">
                                            <el-option label="å¤©æ°”" value="weather" />
                                            <el-option label="åœ°ç†ä½ç½®" value="location" />
                                            <el-option label="é‡‘è" value="finance" />
                                            <el-option label="å·¥å…·" value="utility" />
                                            <el-option label="å…¶ä»–" value="other" />
                                        </el-select>
                                    </el-form-item>
                                    
                                    <el-form-item>
                                        <el-button type="primary" @click="handleRegister" :loading="loading">
                                            æäº¤æ³¨å†Œ
                                        </el-button>
                                        <el-button @click="Object.keys(registerForm).forEach(k => registerForm[k] = ''); registerForm.category = 'other'">
                                            é‡ç½®
                                        </el-button>
                                    </el-form-item>
                                </el-form>
                            </el-card>
                            
                            <el-card class="register-info-card">
                                <h3>æ³¨å†Œè¯´æ˜</h3>
                                <ul>
                                    <li>æ³¨å†Œçš„æœåŠ¡å°†å‡ºç°åœ¨AISIæœåŠ¡ç›®å½•ä¸­</li>
                                    <li>æœåŠ¡IDæ ¼å¼ï¼š<code>aisi://provider/service-name</code></li>
                                    <li>æ³¨å†Œåå¯é€šè¿‡è§£æAPIè·å–æœåŠ¡ç«¯ç‚¹</li>
                                    <li>å»ºè®®ç¡®ä¿APIç¨³å®šå¯ç”¨</li>
                                    <li>å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³» contact@aisi.run</li>
                                </ul>
                            </el-card>
                        </div>
                    </main>
                    
                    <!-- é¡µè„š -->
                    <footer class="app-footer">
                        <div class="footer-content">
                            <p>AISI Protocol Service Registry â€¢ æœåŠ¡åŸå­åŒ–æ³¨å†Œä¸­å¿ƒ v1.0</p>
                            <p>
                                <el-link href="https://aisi.run" target="_blank">aisi.run</el-link> â€¢ 
                                <el-link href="https://github.com/aisi-protocol" target="_blank">GitHub</el-link> â€¢ 
                                <el-link href="mailto:contact@aisi.run">è”ç³»æˆ‘ä»¬</el-link>
                            </p>
                        </div>
                    </footer>
                </div>
            `
        });

        // æ³¨å†Œç»„ä»¶
        app.component(ElButton.name, ElButton);
        app.component(ElForm.name, ElForm);
        app.component(ElFormItem.name, ElFormItem);
        app.component(ElInput.name, ElInput);
        app.component(ElSelect.name, ElSelect);
        app.component(ElOption.name, ElOption);
        app.component(ElCard.name, ElCard);
        app.component(ElTag.name, ElTag);
        app.component(ElRow.name, ElRow);
        app.component(ElCol.name, ElCol);
        app.component(ElPagination.name, ElPagination);
        app.component(ElLink.name, ElLink);
        app.component(ElTabs.name, ElTabs);
        app.component(ElTabPane.name, ElTabPane);

        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
    </script>
</body>
</html>
